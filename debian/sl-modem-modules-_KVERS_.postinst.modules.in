#! /bin/bash
# postinst script for sl-modem

daemon-stop () {
   if [ -e /var/run/slmodemd.pid ] ; then
      /etc/init.d/sl-modem-daemon stop || true
      sleep 1
   fi
}

mkdev ()
{
    local cleanup majo

    perms="660"
    owner="root:dialout"

    # look for nodes with the old major number, also whether the old files to
    # exist at all
    majo=`stat -c %t /dev/$1$2 2>/dev/null`

    if test "$majo" = 212 || test "$majo" = 213 ; then
        mv -f /dev/$1$2 /dev/$1$2.tmp
        cleanup="$cleanup /dev/$1$2.tmp"
        perms="--reference=/dev/$1$2.tmp"
        owner="--reference=/dev/$1$2.tmp"
    fi

    if test -z "$majo" ; then
        mknod -m $perms /dev/$1$2 c $3 $2
        chown $owner /dev/$1$2
    fi

    # workaround for a mistake in old scripts
    if test "`stat -c %u /dev/$1$2`" = 660 ; then
       chown $owner /dev/$1$2
    fi

    rm -f $cleanup
}

   

case "$1" in
   configure)
   # old DEVFS hack should be done by module post-install now
   # test -c /dev/ttySL0 || mknod -m 666 /dev/ttySL0 c 212 0 || true

   update-devfsd  2>/dev/null || true
   update-modules 2>/dev/null || true
   
   for x in 0 1 2 3; do
      mkdev slamr $x 242
      mkdev slusb $x 243
   done

   for module in slamr slusb ; do
      if grep -q "$module" /proc/modules 2>/dev/null ; then
         daemon-stop
         rmmod $module
      fi
   done
   modprobe slamr 2>/dev/null || modprobe slusb 2>/dev/null || true
   if test -x /usr/sbin/slmodemd ; then
      if ! [ -e /var/run/slmodemd.pid ] ; then
         /etc/init.d/sl-modem-daemon start || true
      else
         # restart on upgrades
         if test -n "$2" ; then
            /etc/init.d/sl-modem-daemon restart || true
         fi
      fi
   fi
         
   ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0


